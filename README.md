# Provision EKS clusters with terraform

This is derived from [Learn Terraform Provisioner - EKS Cluster][learn-terraform-eks] and its [companion tutorial][companion].
Significant modifications were made to allow configuration dependencies to be generated by Terraform directly.

Objectives:
- Provision full-featured Kubernetes clusters on AWS with sensible defaults
- Minimize infrastructure costs

Notable defaults:
* Fully encrypted disks & secrets in cluster
* Spot instances and autoscaling 

Notable options for configuration:
* Autoscaling can be disabled
* NAT gateway usage can be disabled

Tested upgrade path from Kubernetes 1.20 to 1.21.
Upgrades are slow, mainly due to unobservable control plane processes in EKS.

## Usage

Configure your cluster details in `terraform.tfvars.json`.

Create the cluster:

```bash
bash -x up.sh
```

When you reconfigure your cluster, either by modifying Terraform files or the variables:

```bash
bash -x up.sh
```

Destroy the cluster:

```bash
bash -x down.sh
```

## Future improvements

- A nice CLI wrapper, perhaps
- A pre-generated admin service account for attaching other management apps
- Smarter automation of security groups
- Cleaner configuration of node groups (right now it seems really disjoint to me)
- Validate the behavior of running applications (e.g. a database) during upgrade

[learn-terraform-eks]: https://github.com/hashicorp/learn-terraform-provision-eks-cluster "learn-terraform-provisioner-eks-cluster"
[companion]: https://learn.hashicorp.com/terraform/kubernetes/provision-eks-cluster "Provision an EKS Cluster learn guide"