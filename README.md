# Provision EKS clusters with terraform

This is derived from [Learn Terraform Provisioner - EKS Cluster][learn-terraform-eks] and its [companion tutorial][companion].
Significant modifications were made to allow configuration dependencies to be generated by Terraform directly.

As per [hashicorp/learn-terraform-provisioner-eks-cluster#48](https://github.com/hashicorp/learn-terraform-provision-eks-cluster/issues/48) this repository is under the MPL 2.0 license.

Objectives:
- Provision full-featured Kubernetes clusters on AWS with sensible defaults
- Minimize infrastructure costs

Notable defaults:
* Fully encrypted disks & secrets in cluster
* Spot instances & autoscaling with various sizes allows for right-sizing to the workload

Notable options for configuration:
* Autoscaling can be disabled
* NAT gateway usage can be disabled

Tested upgrade path from Kubernetes 1.20 to 1.21.
Upgrades are slow, mainly due to unobservable control plane processes in EKS.

## Addons

This automation deploys the following additional software components:

* [Zalando PostgreSQL operator][zalando-pgsql-operator] and its [UI][zalando-ui] for easily deploying and managing database clusters ([user guide][zalando-user-guide], [API reference][zalando-reference])
* [Contour ingress controller][projcontour] for easily deploying, exposing, and routing web services ([Gateway API guide][contour-gateway-api], [tutorial video][contour-101-howto-vid])


Additional components may be added in the future.

## Usage

Configure your cluster details in `terraform.tfvars.json`.

Create the cluster:

```bash
bash -x up.sh
```

When you reconfigure your cluster, either by modifying Terraform files or the variables:

```bash
bash -x up.sh
```

*NB*: because the autoscaler will modify the _desired size_ of each autoscaling group, Terraform will report changes having been made outside of Terraform's operations. 
This is normal, and shouldn't impact application operations.

Destroy the cluster:

```bash
bash -x down.sh
```

## Future improvements

- A nice CLI wrapper, perhaps
- A pre-generated admin service account for attaching other management apps
- Smarter automation of security groups
- Cleaner configuration of node groups (right now it seems really disjoint to me)
- Validate the behavior of running applications (e.g. a database) during upgrade

[learn-terraform-eks]: https://github.com/hashicorp/learn-terraform-provision-eks-cluster "learn-terraform-provisioner-eks-cluster"
[companion]: https://learn.hashicorp.com/terraform/kubernetes/provision-eks-cluster "Provision an EKS Cluster learn guide"
[zalando-pgsql-operator]: https://github.com/zalando/postgres-operator
[zalando-ui]: https://github.com/zalando/postgres-operator/blob/master/docs/operator-ui.md
[zalando-user-guide]: https://github.com/zalando/postgres-operator/blob/master/docs/user.md
[zalando-reference]: https://github.com/zalando/postgres-operator/blob/master/docs/reference/cluster_manifest.md
[contour-101-howto-vid]: https://www.youtube.com/watch?v=xUJbTnN3Dmw
[projcontour]: https://projectcontour.io
[contour-gateway-api]: https://projectcontour.io/guides/gateway-api/